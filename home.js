init();

var isSearching = false;
var searchRequest = null;
var chosenWebsite;
var chosenTool;

function init() {
    addWebsiteEventListener();
    addToolEventListener();
    addBeginSearchEventListener();
    addCancelSearchEventListener();
    addAppListEventListener();
}

function addToolEventListener() {
    var toolDropdown = $("#toolDropdown")
    var tools = toolDropdown.find("li");
    
    tools.on("click", function(){
        var selectedTool = $(this).text();
        $("#toolText").text(selectedTool);
    });    
}

function addWebsiteEventListener() {
    var websiteDropdown = $("#websiteDropdown");
    var websites = websiteDropdown.find("li");
    
    websites.on("click", function(){
        var selectedWebsite = $(this).text();
        $("#websiteText").text(selectedWebsite);
    });
}

function addBeginSearchEventListener() {
    var beginSearchButton = $("#beginSearchButton");

    beginSearchButton.on("click", function() {
        //check if there is already ongoing search
        $(".loader").removeClass("invisible");
        //preform python search
        chosenWebsite = $("#websiteText").text().replace("www.", "").replace(".com", "") + ".py";
        chosenTool = $("#toolText").text().replace(" ", "_") + ".txt";
        alert(chosenTool);
        alert(chosenWebsite);
        isSearching = true;
        runPyScript(chosenWebsite, chosenTool);
    });
}

function addCancelSearchEventListener() {
    var cancelSearchButton = $("#cancelSearchButton");

    cancelSearchButton.on("click", function() {
        if(isSearching) {
            $(".loader").addClass("invisible");
            searchRequest.abort();
            runKillScript();
            isSearching = false;
        }
    });
}

function addAppListEventListener() {
    var appList = $("#appList li");

    appList.on("click", function() {
        if($("#appList .active").exists()) {
            var selectedApp = $("#appList .active");
            selectedApp.removeClass("active");
        }
        $(this).addClass("active");
    });
}

function runPyScript(chosenWebsite, chosenTool) {
    alert(chosenTool)
    searchRequest = $.ajax( {
        url: "http://localhost:8000/cgi-bin/oldversion.py",
        type: "GET",
        async : true,
        data: { toolFile: chosenTool },
        success : processJsonFile
    });
}

function runKillScript() {
    $.ajax( {
        url: "http://localhost:8001/cgi-bin/kill_python_script.py",
        type: "GET",
        async : true,
        data: { pythonFile : chosenWebsite },
        success : function() {
            alert("completed kill");
        }
    });
}

function processJsonFile() {
    alert("webscraping complete");
    var apps = [];

}

jQuery.fn.exists = function() {
    return this.length > 0;
}